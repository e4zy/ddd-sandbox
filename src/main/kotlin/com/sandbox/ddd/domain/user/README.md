# 集約（Aggregate）とは

- オブジェクト間において強い整合性を担保する必要がある一つのまとまり

## 集約のルール

- 外部から集約内のオブジェクトを操作してはいけない
- 集約の操作は、『集約ルート』と呼ばれる親玉となるオブジェクトを介して行う（いわゆるエンティティ）
  - 例：ユーザ名の変更はUserオブジェクトに依頼する
- トランザクションは必ず一つにする（整合性の担保）

## 集約の単位

- 整合性を「強く」確保したいものをまとめる
- データの永続化の単位がそのまま集約の単位になることも多い

## 集約におけるオブジェクトの参照関係

- 集約内 -> インスタンス参照
- 集約外 -> 識別子参照
  - インスタンス参照してしまうと、集約外のドメインを操作する権限を与えてしまうことになるため

## 注意事項

- 集約の単位はできるだけ小さく保つ
  - データのロック範囲やトランザクションが大きくなる
  - 処理が肥大化する
- 複数の集約を同一トランザクションで操作することも可能な限り避ける
  - どうしても行いたい場合、下記も視野に入れる

## 複数集約間の整合性を担保したい場合

- ユースケース層のメソッドで担保する
  - ユースケースで複数集約のリポジトリを呼び出す
    - 他の集約に対して操作を行うことになる部分が気になりポイント
- ドメインイベントを用いて結果整合性を担保する
  - 結果整合性という考え方 ⇔ 即時整合性（ex.トランザクション）
    - あるタイミングにおいて矛盾が発生することを許容する
    - 最終的に整合性を保つような仕組みを作る（バッチ, メッセージキュー, etc.）

## デメテルの法則

- オブジェクト同士のメソッド呼び出しに関するガイドライン
- メソッドを呼び出すオブジェクトは以下の4パターンのみ
  - オブジェクト自身
  - 引数として渡されたオブジェクト
  - インスタンス変数
  - 直接インスタンス化したオブジェクト
